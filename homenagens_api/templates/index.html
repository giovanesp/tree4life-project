{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uma Vida, Uma Árvore | Tree4Life</title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/site.css' %}">

    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDflOnnUrodPRcJfMXQHulDLGH9QVetdpI&callback=initMap"></script>

    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 600px;
            border-radius: 8px;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        #homenagemForm label {
            display: block;
            margin-top: 10px;
            font-weight: 600;
        }

        #homenagemForm input,
        #homenagemForm select {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        #homenagemForm button {
            background-color: #28a745;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 20px;
            margin-right: 10px;
        }

        #homenagemForm button[type="button"] {
            background-color: #6c757d;
        }

        .popup-content {
            font-family: 'Poppins', sans-serif;
            text-align: center;
            max-width: 150px;
        }

        .popup-content img {
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 5px;
        }
    </style>
</head>

<body>
    <header>
        <div>
            <h1>Projeto Uma Vida, Uma Árvore</h1>
            <p>Um legado para as próximas gerações</p>
            <button type="button" onclick="openCadastroModal()">
                Cadastrar Nova
            </button>
        </div>
    </header>

    <div class="container">
        <div id="map" style="height: 100vh; width: 100%;"></div>
    </div>

    <footer>
        <div class="footer-container">
            <div class="footer-copy">
                <p>© 2025 Projeto Uma Vida, Uma Árvore. <br>Todos os direitos reservados.</p>
            </div>
            <div class="partners">
                <ul>
                    <li>
                        <img src="{% static 'images/logo_site_topo.png' %}" alt="Logo do Projeto"
                            title="Projeto Uma Vida, Uma Árvore" height="60">
                    </li>
                    <li>
                        <img src="{% static 'images/rotary.svg' %}" alt="Logo do Rotary International"
                            title="Um Projeto do Rotary Club de Lucas do rio Verde-MT" height="60">
                    </li>
                    <li>
                        <img src="{% static 'images/Lugitech_bg.png' %}" alt="Lugitech"
                            title="Lugitech Inovações Tecnológicas" height="60">
                    </li>
                    <li>Patrocinador 2</li>
                </ul>
            </div>
        </div>
    </footer>

    <div id="cadastroModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeCadastroModal()">&times;</span>
            <h2>Registrar Nova</h2>
            <p>Preencha os dados. A localização é preenchida automaticamente, mas pode ser ajustada.</p>

            <form id="homenagemForm">
                {% csrf_token %}

                <label for="nome">Nome do Homenageado:</label>
                <input type="text" id="nome" name="nome">

                <label for="dataNascimento">Data de Nascimento:</label>
                <input type="date" id="dataNascimento" name="dataNascimento">

                <label for="dataPlantio">Data do Plantio:</label>
                <input type="date" id="dataPlantio" name="dataPlantio" required>

                <label for="especie_id">Espécie da Árvore:</label>
                <select id="especie_id" name="especie_id" required>
                    <option value="">Carregando espécies...</option>
                </select>

                <label for="foto_file">Foto do Homenageado (Anexar ou Câmera):</label>
                <input type="file" id="foto_file" name="foto" accept="image/*" capture="environment">

                <label for="latitude_input">Latitude:</label>
                <input type="text" id="latitude_input" name="latitude" placeholder="Aguardando GPS..." readonly
                    required>

                <label for="longitude_input">Longitude:</label>
                <input type="text" id="longitude_input" name="longitude" placeholder="Aguardando GPS..." readonly
                    required>

                <button type="button" id="toggle_edit_coords"
                    style="background-color: #6c757d; font-size: 0.9em; padding: 5px 10px; margin-top: 5px;">
                    Permitir Edição Manual
                </button>
                <p id="gps_status" style="font-size: 0.9em; color: #007bff; margin-top: 5px;">Status: Inicializando
                    GPS...</p>

                <button type="submit">Cadastrar</button>
                <button type="button" onclick="closeCadastroModal()" style="background-color: #6c757d;">
                    Cancelar
                </button>

                <p id="status-message" style="margin-top: 15px;"></p>
            </form>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://tree4life.lcasistemas.com.br';
        const initialLat = -13.0984;
        const initialLng = -55.9022;
        const initialZoom = 12;
        const DEFAULT_BABY_IMAGE_URL = "{% static 'images/baby.png' %}";

        let map;
        let currentMarkers = [];
        let watchId;
        let isManualOverride = false;
        let speciesIdFromUrl = null;
        let infoWindow;
        let userLocationMarker = null;

        window.initMap = function () {
            const center = { lat: initialLat, lng: initialLng };

            map = new google.maps.Map(document.getElementById('map'), {
                center: center,
                zoom: initialZoom,
                mapTypeId: google.maps.MapTypeId.HYBRID,
                mapTypeControl: true,
                streetViewControl: false,
                fullscreenControl: false,
            });

            infoWindow = new google.maps.InfoWindow();

            // ADICIONADO: Listener para abrir o modal no ponto clicado
            map.addListener('click', (event) => {
                openCadastroModal(true, null, event.latLng);
            });

            loadHomenagens();
        }

        async function loadHomenagens() {
            const url = new URL(`${API_BASE_URL}/api/homenagens/`);
            url.searchParams.append('page', 1);
            url.searchParams.append('limit', 1000);

            try {
                const response = await fetch(url);
                const data = await response.json();
                renderMarkers(data.results || []);
            } catch (error) {
                console.error("Erro ao carregar homenagens:", error);
            }
        }

        function renderMarkers(homenagens) {
            const formatarDataBr = (dataString) => {
                if (!dataString) return 'Data não informada';
                const partes = dataString.split('-');
                if (partes.length === 3) {
                    return `${partes[2]}/${partes[1]}/${partes[0]}`;
                }
                return dataString;
            };

            currentMarkers.forEach(marker => marker.setMap(null));
            currentMarkers = [];

            let bounds = new google.maps.LatLngBounds();

            homenagens.forEach(function (homenagem) {
                if (homenagem.coordenadas && homenagem.coordenadas.length === 2) {
                    const lat = homenagem.coordenadas[0];
                    const lng = homenagem.coordenadas[1];
                    const position = { lat: lat, lng: lng };
                    const fotoParaExibir = (homenagem.foto && homenagem.foto.trim() !== '')
                        ? `${homenagem.foto}`
                        : DEFAULT_BABY_IMAGE_URL;
                    const dataPlantioFormatada = formatarDataBr(homenagem.dataPlantio);

                    const treeIcon = {
                        url: '{% static "images/740938.png" %}',
                        scaledSize: new google.maps.Size(32, 32),
                        origin: new google.maps.Point(0, 0),
                        anchor: new google.maps.Point(16, 32)
                    };

                    const marker = new google.maps.Marker({
                        position: position,
                        map: map,
                        icon: treeIcon,
                        title: homenagem.nome || 'Homenagem Sem Nome'
                    });

                    const contentString = `
                    <div class="popup-content">
                        <img src="${fotoParaExibir}" alt="Foto de ${homenagem.nome || 'Homenageado'}" style="max-width: 60px; height: 60px;">
                        <h3>${homenagem.nome || 'Homenagem Sem Nome'}</h3>
                        <p>Espécie: ${homenagem.especie_nome}<br /> 
                        Plantio: ${dataPlantioFormatada}</p>
                    </div>
                `;

                    marker.addListener('click', () => {
                        infoWindow.setContent(contentString);
                        infoWindow.open(map, marker);
                    });

                    currentMarkers.push(marker);
                    bounds.extend(position);
                }
            });

            if (currentMarkers.length > 0) {
                map.fitBounds(bounds);
            } else {
                map.setCenter({ lat: initialLat, lng: initialLng });
                map.setZoom(initialZoom);
            }
        }

        function startLocationWatch() {
            const latInput = document.getElementById('latitude_input');
            const lngInput = document.getElementById('longitude_input');
            const gpsStatus = document.getElementById('gps_status');

            if (!navigator.geolocation) {
                gpsStatus.textContent = "Status: Geolocalização não suportada.";
                return;
            }

            gpsStatus.textContent = "Status: Tentando obter a localização...";
            latInput.placeholder = "Tentando...";
            lngInput.placeholder = "Tentando...";

            const success = (position) => {
                const { latitude, longitude, accuracy } = position.coords;
                const newLatLng = new google.maps.LatLng(latitude, longitude);

                if (!isManualOverride) {
                    latInput.value = latitude.toFixed(6);
                    lngInput.value = longitude.toFixed(6);
                    gpsStatus.textContent = `Status: Localização atualizada. Precisão: ±${accuracy.toFixed(1)}m`;

                    // 1. Atualiza/Cria o Marcador do Usuário
                    if (userLocationMarker) {
                        userLocationMarker.setPosition(newLatLng);
                    } else {
                        userLocationMarker = new google.maps.Marker({
                            position: newLatLng,
                            map: map,
                            title: 'Sua Posição Atual',
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                fillColor: '#4285F4',
                                fillOpacity: 1.0,
                                strokeColor: '#FFFFFF',
                                strokeWeight: 2,
                                scale: 8
                            }
                        });
                    }

                    // 2. Move e Zoom no Mapa
                    map.setCenter(newLatLng);

                    if (map.getZoom() < 17) {
                        map.setZoom(17);
                    }
                }
            };

            const error = (err) => {
                gpsStatus.textContent = `Status: ERRO GPS (${err.code}). Insira manualmente se necessário.`;
                console.error(`ERRO GPS: ${err.message}`);
                if (userLocationMarker) {
                    userLocationMarker.setMap(null);
                    userLocationMarker = null;
                }
            };

            watchId = navigator.geolocation.watchPosition(success, error, {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            });
        }

        function stopLocationWatch() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            if (userLocationMarker) {
                userLocationMarker.setMap(null);
                userLocationMarker = null;
            }
        }

        function setupManualToggle() {
            const toggleButton = document.getElementById('toggle_edit_coords');
            const latInput = document.getElementById('latitude_input');
            const lngInput = document.getElementById('longitude_input');

            toggleButton.addEventListener('click', () => {
                isManualOverride = !isManualOverride;

                if (isManualOverride) {
                    stopLocationWatch();
                    latInput.readOnly = false;
                    lngInput.readOnly = false;
                    toggleButton.textContent = "Bloquear Edição (Voltar ao GPS)";
                    document.getElementById('gps_status').textContent = "Status: Edição manual ativada.";
                } else {
                    latInput.readOnly = true;
                    lngInput.readOnly = true;
                    toggleButton.textContent = "Permitir Edição Manual";
                    startLocationWatch();
                }
            });
        }

        async function loadSpeciesForForm(defaultSpeciesId = null) {
            const select = document.getElementById('especie_id');
            const url = `${API_BASE_URL}/api/especies/`;
            select.disabled = true;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Falha ao carregar espécies.');
                const especies = await response.json();

                select.innerHTML = '<option value="">Selecione uma Espécie</option>';

                if (especies.length === 0) {
                    select.innerHTML = '<option value="">Nenhuma espécie cadastrada no Admin</option>';
                    return;
                }

                especies.forEach(e => {
                    const option = document.createElement('option');
                    option.value = e.id;
                    option.textContent = e.nome_popular;
                    select.appendChild(option);
                });

                const idToSelect = defaultSpeciesId || speciesIdFromUrl;
                if (idToSelect) {
                    select.value = idToSelect;
                    speciesIdFromUrl = null;
                }
                select.disabled = false;

            } catch (error) {
                console.error("Erro ao carregar espécies:", error);
                select.innerHTML = '<option value="">Erro ao carregar espécies</option>';
            }
        }

        function checkUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const form = document.getElementById('homenagemForm');

            const paramMap = {
                'plantio': 'dataPlantio',
                'especie': 'especie_id',
                'lat': 'latitude_input',
                'lng': 'longitude_input',
                'nome': 'nome',
                'nascimento': 'dataNascimento'
            };

            let paramsFound = false;
            let coordsPreFilled = false;

            for (const [urlParam, formId] of Object.entries(paramMap)) {
                if (params.has(urlParam)) {
                    const value = params.get(urlParam);

                    if (urlParam === 'especie') {
                        speciesIdFromUrl = value;
                    } else {
                        const input = document.getElementById(formId);
                        if (input) {
                            input.value = value;
                        }
                    }

                    paramsFound = true;
                    if (urlParam === 'lat' || urlParam === 'lng') {
                        coordsPreFilled = true;
                    }
                }
            }

            if (paramsFound) {
                if (coordsPreFilled) {
                    isManualOverride = true;
                    document.getElementById('latitude_input').readOnly = false;
                    document.getElementById('longitude_input').readOnly = false;
                    document.getElementById('gps_status').textContent = "Status: Localização pré-preenchida via URL.";
                    document.getElementById('toggle_edit_coords').textContent = "Bloquear Edição (Voltar ao GPS)";
                }

                window.openCadastroModal(false, speciesIdFromUrl);
            }
        }

        window.openCadastroModal = function (resetForm = true, defaultSpeciesId = null, clickPos = null) {
            const modal = document.getElementById('cadastroModal');
            const latInput = document.getElementById('latitude_input');
            const lngInput = document.getElementById('longitude_input');


            if (resetForm) {
                document.getElementById('homenagemForm').reset();
                isManualOverride = false;
                latInput.readOnly = true;
                lngInput.readOnly = true;
                document.getElementById('toggle_edit_coords').textContent = "Permitir Edição Manual";
                startLocationWatch();
                document.getElementById('gps_status').textContent = "Status: Tentando obter a localização...";
            }

            if (clickPos) {
                stopLocationWatch();
                isManualOverride = true;

                latInput.value = clickPos.lat().toFixed(6);
                lngInput.value = clickPos.lng().toFixed(6);

                latInput.readOnly = false;
                lngInput.readOnly = false;
                document.getElementById('toggle_edit_coords').textContent = "Bloquear Edição (Voltar ao GPS)";
                document.getElementById('gps_status').textContent = "Status: Localização escolhida no mapa.";
            }

            if (modal.style.display !== 'block') {
                modal.style.display = 'block';

                loadSpeciesForForm(defaultSpeciesId);

                if (!clickPos && !resetForm) {
                    startLocationWatch();
                }

                document.getElementById('status-message').textContent = '';
            }
        }

        window.closeCadastroModal = function () {
            document.getElementById('cadastroModal').style.display = 'none';
            stopLocationWatch();
        }

        document.addEventListener('DOMContentLoaded', () => {
            setupManualToggle();

            checkUrlParams();

            const form = document.getElementById('homenagemForm');
            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const statusMessage = document.getElementById('status-message');
                    statusMessage.style.color = 'black';
                    statusMessage.textContent = "Enviando dados...";

                    const dataPlantio = document.getElementById('dataPlantio').value;
                    const especie_id = document.getElementById('especie_id').value;
                    const latitude = document.getElementById('latitude_input').value;
                    const longitude = document.getElementById('longitude_input').value;

                    if (!dataPlantio || !especie_id || !latitude || !longitude) {
                        statusMessage.textContent = "Erro: Data do Plantio, Espécie e Coordenadas são obrigatórios para a árvore.";
                        statusMessage.style.color = 'red';
                        return;
                    }

                    try {
                        const formData = new FormData(form);

                        const response = await fetch(`${API_BASE_URL}/api/homenagens/`, {
                            method: 'POST',
                            body: formData,
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            let errorMessage = 'Falha no cadastro. Verifique os dados.';

                            if (errorData) {
                                const detailedErrors = Object.keys(errorData).map(key => `${key}: ${errorData[key]}`).join('; ');
                                errorMessage = `Falha no cadastro: ${detailedErrors}`;
                            }
                            throw new Error(errorMessage);
                        }

                        statusMessage.textContent = "Homenagem cadastrada com sucesso! Recarregando mapa...";

                        closeCadastroModal();
                        await loadHomenagens();

                    } catch (error) {
                        console.error("Erro no envio:", error);
                        statusMessage.textContent = `Erro no cadastro: ${error.message || error}`;
                        statusMessage.style.color = 'red';
                    }
                });
            }
        });
    </script>
</body>

</html>